<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OCPP WSS Panel</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --bg-color: #f1f3f5;
      --container-bg: #fff;
      --header-bg: #888;
      --header-text: #fff;
      --text-color: #333;
      --border-color: #e0e0e0;
      --detail-bg: #fafbfc;
      --table-header-bg: #f0f0f0;
      --button-bg: #007bff;
      --button-text: #fff;
      --status-color: #555;
      --timestamp-color: #888;
      --toggle-bg: #fff;
      --toggle-border: #ccc;
      --toggle-shadow: rgba(0,0,0,0.1);
      --modal-bg: #fff;
      --modal-border: #e0e0e0;
      --input-bg: #f9f9f9;
      --input-border: #ccc;
    }
    :root.dark-mode {
      --bg-color: #1a1a1a;
      --container-bg: #2d2d2d;
      --header-bg: #444;
      --header-text: #fff;
      --text-color: #ddd;
      --border-color: #444;
      --detail-bg: #252525;
      --table-header-bg: #333;
      --button-bg: #1e90ff;
      --button-text: #fff;
      --status-color: #aaa;
      --timestamp-color: #888;
      --toggle-bg: #333;
      --toggle-border: #555;
      --toggle-shadow: rgba(0,0,0,0.3);
      --modal-bg: #2d2d2d;
      --modal-border: #444;
      --input-bg: #333;
      --input-border: #555;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .navbar {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-title {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .navbar-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .suffix-btn {
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .suffix-btn.active {
      background: #0056b3;
      font-weight: bold;
    }
    .mode-toggle {
      margin-left: 1rem;
      width: 2.5rem;
      height: 2.5rem;
      background: var(--toggle-bg);
      border: 2px solid var(--toggle-border);
      border-radius: 50%;
      box-shadow: 0 2px 6px var(--toggle-shadow);
      cursor: pointer;
      position: relative;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .3s ease, border-color .3s ease, box-shadow .3s ease;
    }
    .mode-toggle:hover {
      box-shadow: 0 4px 12px var(--toggle-shadow);
    }
    .mode-toggle .icon {
      position: absolute;
      width: 1.4rem;
      height: 1.4rem;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      transition: transform .5s ease, opacity .5s ease;
    }
    .mode-toggle .moon {
      transform: scale(1) rotate(0deg);
      opacity: 1;
      color: #f1c40f;
    }
    .mode-toggle .sun {
      transform: scale(0) rotate(90deg);
      opacity: 0;
      color: #f39c12;
    }
    :root.dark-mode .mode-toggle .moon {
      transform: scale(0) rotate(-90deg);
      opacity: 0;
    }
    :root.dark-mode .mode-toggle .sun {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
    .container {
      width: 98%;
      background: var(--container-bg);
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      margin: 1rem;
    }
    .content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #log, #detail {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    #log::-webkit-scrollbar, #detail::-webkit-scrollbar { display: none; }
    #log:hover, #detail:hover { scrollbar-width: thin; -ms-overflow-style: auto; }
    #log:hover::-webkit-scrollbar, #detail:hover::-webkit-scrollbar {
      display: block; width:8px;
    }
    #log:hover::-webkit-scrollbar-track, #detail:hover::-webkit-scrollbar-track {
      background: var(--border-color);
    }
    #log:hover::-webkit-scrollbar-thumb, #detail:hover::-webkit-scrollbar-thumb {
      background: var(--header-bg); border-radius:4px;
    }
    #log { overflow-x: hidden; }
    #detail { border-left:1px solid var(--border-color); background:var(--detail-bg); }
    .entry {
      margin-bottom: .5rem;
      font-family: monospace;
      line-height: 1.4;
      display:flex; align-items:flex-start; width:100%;
    }
    .entry .ts {
      color: var(--timestamp-color);
      font-size: .85em;
      width:150px; flex-shrink:0; white-space:nowrap;
    }
    .entry .msg {
      flex:1; overflow-wrap:break-word; max-width:calc(100% - 150px);
    }
    .entry.status {
      font-style:italic; color:var(--status-color);
    }
    .subheader {
      font-weight:bold; margin:1rem 0 .5rem; font-size:1.2rem;
    }
    .filter {
      margin-bottom:.5rem;
    }
    .filter label {
      margin-right:1rem; font-size:1rem;
    }
    .filter select {
      padding:.4rem; border-radius:4px; border:1px solid var(--border-color);
      background:var(--container-bg); color:var(--text-color); font-size:.9rem;
    }
    table {
      width:100%; border-collapse:collapse; margin:.5rem 0;
      font-family:monospace; font-size:.9rem;
    }
    th, td {
      padding:.5rem; border:1px solid var(--border-color);
      text-align:left; word-break:break-all;
    }
    th { background:var(--table-header-bg); }
    #call-table td:first-child, #result-table td:first-child,
    #call-desc td:first-child, #result-desc td:first-child {
      white-space:nowrap;
    }
    .table-footer {
      display:flex; align-items:center; margin-bottom:1rem; gap:.5rem;
    }
    .table-footer.response-footer { justify-content:flex-end; }
    .button-group { display:flex; gap:.5rem; }
    #toggleBtn, #getBtn {
      background:var(--button-bg); color:var(--button-text);
      border:none; padding:.4rem .8rem; border-radius:4px;
      cursor:pointer; font-size:1rem;
    }
    #getConverterBtn, #setConverterBtn, #setRelayBtn,
    #getConnectorStatusBtn, #getEVInfoBtn {
      background:var(--table-header-bg); color:#000;
      border:1px solid var(--border-color);
      padding:.4rem .8rem; border-radius:4px; cursor:pointer; font-size:1rem;
    }
    :root.dark-mode #getConverterBtn,
    :root.dark-mode #setConverterBtn,
    :root.dark-mode #setRelayBtn,
    :root.dark-mode #getConnectorStatusBtn,
    :root.dark-mode #getEVInfoBtn {
      color:#fff;
    }
    #toggleBtn:hover, #getBtn:hover,
    .suffix-btn:hover {
      background:#3ca3f7;
    }
    .suffix-btn.active:hover {
      background: #0056b3;
    }
    #getConverterBtn:hover, #setConverterBtn:hover,
    #setRelayBtn:hover, #getConnectorStatusBtn:hover,
    #getEVInfoBtn:hover {
      background:#c0c0c0;
    }
    #toggleBtn { margin-left:auto; }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--modal-bg);
      border: 1px solid var(--modal-border);
      border-radius: 8px;
      padding: 1.5rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .modal-header {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    .modal-body {
      margin-bottom: 1rem;
    }
    .modal-body label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    .modal-body input, .modal-body select {
      width: 100%;
      padding: 0.4rem;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .modal-btn {
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .modal-btn.cancel {
      background: #6c757d;
    }
    .modal-btn:hover {
      background: #3ca3f7;
    }
    .modal-btn.cancel:hover {
      background: #5a6268;
    }
    @media(max-width:700px){
      .content { flex-direction:column; }
      #detail { border-left:none; border-top:1px solid var(--border-color); }
      .entry .ts { width:120px; }
      .entry .msg { max-width:calc(100% - 120px); }
      .modal-content { width: 95%; }
    }
  /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 0.8rem 1.5rem;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 2000;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-10px);
      }
      :root.dark-mode .toast {
        background: #555;
      }
      @media(max-width:700px){
        .content { flex-direction:column; }
        #detail { border-left:none; border-top:1px solid var(--border-color); }
        .entry .ts { width:120px; }
        .entry .msg { max-width:calc(100% - 120px); }
        .modal-content { width: 95%; }
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <div class="navbar-title">
        OCPP WSS Panel –> <span id="currentCP"></span>
      </div>
      <div class="navbar-buttons">
        <button class="suffix-btn" id="cp01Btn" onclick="switchCP('CP_01')">CP_01</button>
        <button class="suffix-btn" id="cp02Btn" onclick="switchCP('CP_02')">CP_02</button>
        <button class="suffix-btn" id="cp03Btn" onclick="switchCP('CP_03')">CP_03</button>
        <button class="mode-toggle" id="modeToggleBtn" title="Switch to Dark Mode">
          <svg class="icon moon" viewBox="0 0 24 24">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
          </svg>
          <svg class="icon sun" viewBox="0 0 24 24">
            <path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.36 6.36l-1.42-1.42M6.34 6.34L4.93 4.93m12.02 0l-1.42 1.42M6.34 17.66l-1.42 1.42M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
        </button>
      </div>
    </div>
  
    <div class="container">
      <div class="content">
        <div id="log">
          <div class="entry status"><span class="ts">--:--:--</span><span class="msg">Connecting…</span></div>
        </div>
        <div id="detail">
          <div class="subheader">Request</div>
          <div class="filter">
            <label for="callFilter">Filter Requests:</label>
            <select id="callFilter"><option value="all">All</option></select>
          </div>
          <table id="call-table">
            <thead><tr><th>Timestamp</th><th>Raw JSON</th></tr></thead>
            <tbody></tbody>
          </table>
          <table id="call-desc">
            <thead><tr><th>Name</th><th>Value</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="table-footer">
            <div class="button-group">
              <button id="getConverterBtn">GetConverter</button>
              <button id="setConverterBtn">SetConverter</button>
              <button id="setRelayBtn">SetRelay</button>
              <button id="getConnectorStatusBtn">GetConnectorStatus</button>
              <button id="getEVInfoBtn">GetEVInfo</button>
            </div>
            <button id="toggleBtn">Start</button>
          </div>
          <div class="subheader">Response</div>
          <div class="filter">
            <label for="resultFilter">Filter Responses:</label>
            <select id="resultFilter"><option value="all">All</option></select>
          </div>
          <table id="result-table">
            <thead><tr><th>Timestamp</th><th>Raw JSON</th></tr></thead>
            <tbody></tbody>
          </table>
          <table id="result-desc">
            <thead><tr><th>Name</th><th>Value</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="table-footer response-footer">
            <button id="getBtn">Get</button>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Modal for SetConverter and SetRelay -->
    <div class="modal" id="commandModal">
      <div class="modal-content">
        <div class="modal-header" id="modalTitle"></div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
          <button class="modal-btn cancel" id="modalCancel">Cancel</button>
          <button class="modal-btn" id="modalSubmit">Submit</button>
        </div>
      </div>
    </div>
  
    <script>
    (function(){
      const host = location.hostname || "localhost", port = 2409;
      let currentCP = '', ws;
      const log           = document.getElementById('log'),
            tblCall       = document.querySelector('#call-table tbody'),
            descCall      = document.querySelector('#call-desc tbody'),
            tblResult     = document.querySelector('#result-table tbody'),
            descResult    = document.querySelector('#result-desc tbody'),
            toggleBtn     = document.getElementById('toggleBtn'),
            getBtn        = document.getElementById('getBtn'),
            getConverterBtn       = document.getElementById('getConverterBtn'),
            setConverterBtn       = document.getElementById('setConverterBtn'),
            setRelayBtn           = document.getElementById('setRelayBtn'),
            getConnectorStatusBtn = document.getElementById('getConnectorStatusBtn'),
            getEVInfoBtn          = document.getElementById('getEVInfoBtn'),
            modeToggleBtn = document.getElementById('modeToggleBtn'),
            callFilter    = document.getElementById('callFilter'),
            resultFilter  = document.getElementById('resultFilter'),
            detail        = document.getElementById('detail'),
            cp01Btn       = document.getElementById('cp01Btn'),
            cp02Btn       = document.getElementById('cp02Btn'),
            cp03Btn       = document.getElementById('cp03Btn'),
            currentCPSpan = document.getElementById('currentCP'),
            modal         = document.getElementById('commandModal'),
            modalTitle    = document.getElementById('modalTitle'),
            modalBody     = document.getElementById('modalBody'),
            modalCancel   = document.getElementById('modalCancel'),
            modalSubmit   = document.getElementById('modalSubmit');
  
      let requestCommands  = new Set(['all']),
          responseCommands = new Set(['all']),
          messages         = { call: [], result: [] };
  
      // Toast Notification Function
      function showToast(message) {
        let toast = document.querySelector('.toast');
        if (!toast) {
          toast = document.createElement('div');
          toast.className = 'toast';
          document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300); // Remove after fade-out
        }, 3000); // Display for 3 seconds
      }
  
      function updateActiveButton(){
        cp01Btn.classList.toggle('active', currentCP==='CP_01');
        cp02Btn.classList.toggle('active', currentCP==='CP_02');
        cp03Btn.classList.toggle('active', currentCP==='CP_03');
      }
      function updateTitle(){
        currentCPSpan.textContent = currentCP;
      }
      function getWebSocketUrl(){
        return `ws://${host}:${port}/${currentCP}`;
      }
      window.switchCP = function(cp){
        if(cp === currentCP) return;
        currentCP = cp;
        updateActiveButton();
        updateTitle();
        if(ws && ws.readyState === WebSocket.OPEN) ws.close();
        log.innerHTML = `<div class="entry status"><span class="ts">--:--:--</span><span class="msg">Connecting to ${cp}…</span></div>`;
        requestCommands  = new Set(['all']);
        responseCommands = new Set(['all']);
        messages = { call: [], result: [] };
        tblCall.innerHTML    = '';
        descCall.innerHTML   = '';
        tblResult.innerHTML  = '';
        descResult.innerHTML = '';
        updateDropdown(callFilter, requestCommands);
        updateDropdown(resultFilter, responseCommands);
        connect();
      };
  
      modeToggleBtn.addEventListener('click', ()=>{
        const isDark = document.documentElement.classList.toggle('dark-mode');
        modeToggleBtn.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
      });
      toggleBtn.addEventListener('click', ()=>{
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        const action = toggleBtn.textContent==='Start'?'start':'stop';
        toggleBtn.textContent = action==='start'?'Stop':'Start';
        ws.send(action);
        detail.scrollTop = detail.scrollHeight;
      });
      getBtn.addEventListener('click', ()=>{
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        ws.send('get');
        detail.scrollTop = detail.scrollHeight;
      });
      getConverterBtn.addEventListener('click',()=>{
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        ws.send('getConverter');
        detail.scrollTop = detail.scrollHeight;
      });
      getConnectorStatusBtn.addEventListener('click',()=>{
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        ws.send('getConnectorStatus');
        detail.scrollTop = detail.scrollHeight;
      });
      getEVInfoBtn.addEventListener('click',()=>{
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        ws.send('getEVInfo');
        detail.scrollTop = detail.scrollHeight;
      });
      setConverterBtn.addEventListener('click', () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        showModal('setConverter');
      });
      setRelayBtn.addEventListener('click', () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        showModal('setRelay');
      });
      modalSubmit.addEventListener('click', () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          modal.style.display = 'none';
          return;
        }
        // Existing modalSubmit logic
        let command = modalTitle.textContent === 'Set Converter' ? 'setConverter' : 'setRelay';
        let payload = { ChargerID: currentCP };
        if (command === 'setConverter') {
          payload.Status = document.getElementById('converterStatus').value;
          payload.Voltage = parseInt(document.getElementById('voltage').value);
          payload.Current = parseInt(document.getElementById('current').value);
        } else {
          payload.Status = document.getElementById('relayStatus').value;
        }
        const uniqueId = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>
          (c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)
        );
        const message = [
          2,
          uniqueId,
          "DataTransfer",
          {
            command: command === 'setConverter' ? 'SetConverter' : 'SetRelay',
            payload: payload
          }
        ];
        ws.send(JSON.stringify(message));
        detail.scrollTop = detail.scrollHeight;
        modal.style.display = 'none';
      });
      modalCancel.addEventListener('click', () => {
        modal.style.display = 'none';
      });
  
      function showModal(command) {
        modalTitle.textContent = command === 'setConverter' ? 'Set Converter' : 'Set Relay';
        modalBody.innerHTML = '';
        if (command === 'setConverter') {
          modalBody.innerHTML = `
            <label for="converterStatus">Status:</label>
            <select id="converterStatus">
              <option value="On">On</option>
              <option value="Off">Off</option>
            </select>
            <label for="voltage">Voltage (V):</label>
            <input type="number" id="voltage" value="0" min="0" step="1">
            <label for="current">Current (A):</label>
            <input type="number" id="current" value="0" min="0" step="1">
          `;
        } else {
          modalBody.innerHTML = `
            <label for="relayStatus">Status:</label>
            <select id="relayStatus">
              <option value="On">On</option>
              <option value="Off">Off</option>
            </select>
          `;
        }
        modal.style.display = 'flex';
      }
  
      function nowTs(){
        const d=new Date(), z=n=>String(n).padStart(2,'0');
        return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
      }
      function appendLog(msg,cls=''){
        const e=document.createElement('div'),
              ts=document.createElement('span'),
              ms=document.createElement('span');
        e.className='entry'+(cls?' '+cls:'');
        ts.className='ts'; ts.textContent=nowTs();
        ms.className='msg'; ms.textContent=msg;
        e.append(ts,ms);
        log.appendChild(e);
        log.scrollTop=log.scrollHeight;
      }
      function updateDropdown(dropdown,cmds){
        const sel=dropdown.value;
        dropdown.innerHTML='';
        cmds.forEach(c=>{
          const o=document.createElement('option');
          o.value=c; o.textContent=c;
          dropdown.appendChild(o);
        });
        dropdown.value = cmds.has(sel)?sel:'all';
      }
      function setLatest(tbl,desc,raw,type){
        const atBottom = detail.scrollHeight-detail.clientHeight<=detail.scrollTop+1;
        const filter = type==='call'?callFilter.value:resultFilter.value;
        if(filter==='all'||messages[type].slice(-1)[0].command===filter){
          tbl.innerHTML=''; desc.innerHTML='';
          const tr=document.createElement('tr'),
                td1=document.createElement('td'),
                td2=document.createElement('td');
          td1.innerHTML=`<span class="ts">${nowTs()}</span>`;
          td2.textContent=raw;
          tr.append(td1,td2); tbl.appendChild(tr);
          let o;
          try{ o=JSON.parse(raw); }
          catch{
            const r=document.createElement('tr'),
                  n=document.createElement('td'),
                  v=document.createElement('td');
            n.textContent='raw'; v.textContent=raw;
            r.append(n,v); desc.appendChild(r);
            if(atBottom) detail.scrollTop=detail.scrollHeight;
            return;
          }
          if(Array.isArray(o)){
            o.forEach((v,i)=>{
              const r=document.createElement('tr'),
                    n=document.createElement('td'),
                    v2=document.createElement('td');
              n.textContent=`Index ${i}`;
              v2.textContent=typeof v==='object'?JSON.stringify(v):String(v);
              r.append(n,v2); desc.appendChild(r);
            });
          } else if(o&&typeof o==='object'){
            Object.entries(o).forEach(([k,v])=>{
              const r=document.createElement('tr'),
                    n=document.createElement('td'),
                    v2=document.createElement('td');
              n.textContent=k;
              v2.textContent=typeof v==='object'?JSON.stringify(v):String(v);
              r.append(n,v2); desc.appendChild(r);
            });
          } else {
            const r=document.createElement('tr'),
                  n=document.createElement('td'),
                  v2=document.createElement('td');
            n.textContent='value'; v2.textContent=String(o);
            r.append(n,v2); desc.appendChild(r);
          }
          if(atBottom) detail.scrollTop=detail.scrollHeight;
        }
      }
      function categorize(raw){
        let o;
        try{ o=JSON.parse(raw); }catch{return;}
        if(!Array.isArray(o)) return;
        const t0=o[0], ts=nowTs();
        if(t0===2){
          const cmd=o[2]; if(cmd==='Heartbeat') return;
          requestCommands.add(cmd);
          messages.call.push({command:cmd,raw,ts});
          updateDropdown(callFilter,requestCommands);
          setLatest(tblCall,descCall,raw,'call');
        } else if(t0===3){
          const p=o[2];
          if(p&&p.command){
            const cmd=p.command;
            responseCommands.add(cmd);
            messages.result.push({command:cmd,raw,ts});
            updateDropdown(resultFilter,responseCommands);
            setLatest(tblResult,descResult,raw,'result');
          } else {
            messages.result.push({command:null,raw,ts});
            setLatest(tblResult,descResult,raw,'result');
          }
        }
      }
      function updateTable(type){
        const tbl  = type==='call'?tblCall:tblResult,
              desc = type==='call'?descCall:descResult,
              filter = type==='call'?callFilter.value:resultFilter.value;
        tbl.innerHTML=''; desc.innerHTML='';
        const arr = filter==='all'?messages[type]:messages[type].filter(m=>m.command===filter);
        if(arr.length) setLatest(tbl,desc,arr[arr.length-1].raw,type);
      }
      callFilter.addEventListener('change',()=>{
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        updateTable('call');
      });
      resultFilter.addEventListener('change',()=>{
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showToast('No server connection');
          return;
        }
        updateTable('result');
      });
      function connect(){
        appendLog(`Connecting to ${getWebSocketUrl()}`,'status');
        ws=new WebSocket(getWebSocketUrl());
        ws.onopen    =()=>appendLog('Connected','status');
        ws.onmessage =ev=>{ appendLog(ev.data); categorize(ev.data); };
        ws.onclose   =()=>{ appendLog('Connection closed; retrying in 3s…','status'); setTimeout(connect,3000); };
        ws.onerror   =err=>{ console.error(err); appendLog('WebSocket error','status'); };
      }
      // initialize
      updateActiveButton();
      updateTitle();
      updateDropdown(callFilter, requestCommands);
      updateDropdown(resultFilter, responseCommands);
      connect();
    })();
    </script>
  </body>
</html>
