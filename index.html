<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OCPP WSS Panel</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f1f3f5;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 95%;
      max-width: 1500px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 95vh;
      overflow: hidden;
    }
    .header {
      background: #888;
      color: #fff;
      text-align: center;
      padding: 1rem;
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    .content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #log, #detail {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    #detail {
      border-left: 1px solid #e0e0e0;
      background: #fafbfc;
    }
    .entry {
      margin-bottom: .5rem;
      font-family: monospace;
      line-height: 1.4;
      word-wrap: break-word;
    }
    .entry .ts {
      color: #888;
      margin-right: .5rem;
      font-size: .85em;
    }
    .entry.status {
      font-style: italic;
      color: #555;
    }
    .subheader {
      font-weight: bold;
      margin: 1rem 0 .5rem;
      font-size: 1.2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: .5rem 0;
      font-family: monospace;
      font-size: .9rem;
    }
    th, td {
      padding: .5rem;
      border: 1px solid #ddd;
      text-align: left;
      word-break: break-all;
    }
    th { background: #f0f0f0; }
    .table-footer {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }
    #toggleBtn {
      background: #007bff;
      color: #fff;
      border: none;
      padding: .4rem .8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    @media(max-width:700px){
      .content { flex-direction: column; }
      #detail { border-left: none; border-top: 1px solid #e0e0e0; }
      .table-footer { margin-bottom: .5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">OCPP WSS Panel</div>
    <div class="content">
      <div id="log">
        <div class="entry status"><span class="ts">--:--:--</span>Connecting…</div>
      </div>
      <div id="detail">
        <div class="subheader">Startup Notification</div>
        <table id="boot-table">
          <thead><tr><th>Timestamp</th><th>Raw JSON</th></tr></thead>
          <tbody></tbody>
        </table>
        <table id="boot-desc">
          <thead><tr><th>Name</th><th>Value</th></tr></thead>
          <tbody></tbody>
        </table>

        <div class="subheader">Request</div>
        <table id="call-table">
          <thead><tr><th>Timestamp</th><th>Raw JSON</th></tr></thead>
          <tbody></tbody>
        </table>
        <table id="call-desc">
          <thead><tr><th>Name</th><th>Value</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="table-footer">
          <button id="toggleBtn">Start</button>
        </div>

        <div class="subheader">Response</div>
        <table id="result-table">
          <thead><tr><th>Timestamp</th><th>Raw JSON</th></tr></thead>
          <tbody></tbody>
        </table>
        <table id="result-desc">
          <thead><tr><th>Name</th><th>Value</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const host      = location.hostname,
          port      = 2409,
          url       = `ws://${host}:${port}/Ctr`;


    const log        = document.getElementById('log'),
          tblBoot    = document.querySelector('#boot-table tbody'),
          descBoot   = document.querySelector('#boot-desc tbody'),
          tblCall    = document.querySelector('#call-table tbody'),
          descCall   = document.querySelector('#call-desc tbody'),
          tblResult  = document.querySelector('#result-table tbody'),
          descResult = document.querySelector('#result-desc tbody'),
          toggleBtn  = document.getElementById('toggleBtn');

    let ws;  // <-- WebSocket reference in outer scope

    // Toggle Start/Stop on button click AND send command to server
    toggleBtn.addEventListener('click', () => {
      const action = toggleBtn.textContent === 'Start' ? 'start' : 'stop';
      toggleBtn.textContent = action === 'start' ? 'Stop' : 'Start';
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(action);
      }
    });

    function nowTs(){
      const d = new Date(), z = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`
           + ` ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
    }

    function appendLog(msg, cls=''){
      const e = document.createElement('div'),
            ts = document.createElement('span');
      e.className = 'entry' + (cls ? ' ' + cls : '');
      ts.className = 'ts';
      ts.textContent = nowTs();
      e.appendChild(ts);
      e.appendChild(document.createTextNode(msg));
      log.appendChild(e);
      log.scrollTop = log.scrollHeight;
    }

    function setLatest(tbodyRaw, tbodyDesc, raw){
      tbodyRaw.innerHTML = '';
      const trR  = document.createElement('tr'),
            tdT = document.createElement('td'),
            tdJ = document.createElement('td');
      tdT.innerHTML = `<span class="ts">${nowTs()}</span>`;
      tdJ.textContent = raw;
      trR.append(tdT, tdJ);
      tbodyRaw.appendChild(trR);

      tbodyDesc.innerHTML = '';
      let obj;
      try { obj = JSON.parse(raw); }
      catch {
        const tr = document.createElement('tr'),
              tdN = document.createElement('td'),
              tdV = document.createElement('td');
        tdN.textContent = 'raw'; tdV.textContent = raw;
        tr.append(tdN, tdV);
        tbodyDesc.appendChild(tr);
        return;
      }
      if (Array.isArray(obj)) {
        obj.forEach((v,i)=>{
          const tr = document.createElement('tr'),
                tdN = document.createElement('td'),
                tdV = document.createElement('td');
          tdN.textContent = `Index ${i}`;
          tdV.textContent = typeof v==='object' ? JSON.stringify(v) : String(v);
          tr.append(tdN, tdV);
          tbodyDesc.appendChild(tr);
        });
      } else if (obj && typeof obj==='object') {
        for (const [k,v] of Object.entries(obj)) {
          const tr = document.createElement('tr'),
                tdN = document.createElement('td'),
                tdV = document.createElement('td');
          tdN.textContent = k;
          tdV.textContent = typeof v==='object' ? JSON.stringify(v) : String(v);
          tr.append(tdN, tdV);
          tbodyDesc.appendChild(tr);
        }
      } else {
        const tr = document.createElement('tr'),
              tdN = document.createElement('td'),
              tdV = document.createElement('td');
        tdN.textContent = 'value';
        tdV.textContent = String(obj);
        tr.append(tdN, tdV);
        tbodyDesc.appendChild(tr);
      }
    }

    function categorize(raw){
      let obj;
      try { obj = JSON.parse(raw); }
      catch { return; }
      if (!Array.isArray(obj)) return;
      const t0     = obj[0],
            action = obj[2];
      if (t0 === 2 && action === "BootNotification") {
        setLatest(tblBoot, descBoot, raw);
      }
      else if (t0 === 2) {
        setLatest(tblCall, descCall, raw);
      }
      else if (t0 === 3) {
        setLatest(tblResult, descResult, raw);
      }
    }

    function connect(){
      appendLog(`Connecting to ${url}`, 'status');
      ws = new WebSocket(url);
      ws.onopen    = () => appendLog('Connected', 'status');
      ws.onmessage = ev => {
        appendLog(ev.data);
        categorize(ev.data);
      };
      ws.onclose   = () => {
        appendLog('Connection closed; retrying in 3s…', 'status');
        setTimeout(connect, 3000);
      };
      ws.onerror   = err => {
        console.error('WS error', err);
        appendLog('WebSocket error', 'status');
      };
    }

    connect();
  })();
  </script>
</body>
</html>
