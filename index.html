<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OCPP WSS Center</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --bg-color: #f1f3f5;
      --container-bg: #fff;
      --header-bg: #888;
      --header-text: #fff;
      --text-color: #333;
      --border-color: #e0e0e0;
      --detail-bg: #fafbfc;
      --table-header-bg: #f0f0f0;
      --button-bg: #007bff;
      --button-text: #fff;
      --status-color: #555;
      --timestamp-color: #888;
      --toggle-bg: #fff;
      --toggle-border: #ccc;
      --toggle-shadow: rgba(0,0,0,0.1);
      --modal-bg: #fff;
      --modal-border: #e0e0e0;
      --input-bg: #f9f9f9;
      --input-border: #ccc;
      --command-btn-hover: #d8d8d8;
      --emergency-btn-bg: #dc3545;
      --emergency-btn-hover: #c82333;
      --switch-bg-off: #ccc;
      --switch-bg-on: #28a745;
      --switch-handle: #fff;
      --switch-shadow: rgba(0,0,0,0.2);
    }
    :root.dark-mode {
      --bg-color: #1a1a1a;
      --container-bg: #2d2d2d;
      --header-bg: #444;
      --header-text: #fff;
      --text-color: #ddd;
      --border-color: #444;
      --detail-bg: #252525;
      --table-header-bg: #333;
      --button-bg: #1e90ff;
      --button-text: #fff;
      --status-color: #aaa;
      --timestamp-color: #888;
      --toggle-bg: #333;
      --toggle-border: #555;
      --toggle-shadow: rgba(0,0,0,0.3);
      --modal-bg: #2d2d2d;
      --modal-border: #444;
      --input-bg: #333;
      --input-border: #555;
      --command-btn-hover: #2a2a2a;
      --emergency-btn-bg: #c82333;
      --emergency-btn-hover: #b31b2b;
      --switch-bg-off: #555;
      --switch-bg-on: #28a745;
      --switch-handle: #ddd;
      --switch-shadow: rgba(0,0,0,0.4);
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .navbar {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-title {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .navbar-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .suffix-btn {
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .suffix-btn.active {
      background: #0056b3;
      font-weight: bold;
    }
    .mode-toggle {
      margin-left: 1rem;
      width: 2.5rem;
      height: 2.5rem;
      background: var(--toggle-bg);
      border: 2px solid var(--toggle-border);
      border-radius: 50%;
      box-shadow: 0 2px 6px var(--toggle-shadow);
      cursor: pointer;
      position: relative;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .3s ease, border-color .3s ease, box-shadow .3s ease;
    }
    .mode-toggle:hover {
      box-shadow: 0 4px 12px var(--toggle-shadow);
    }
    .mode-toggle .icon {
      position: absolute;
      width: 1.4rem;
      height: 1.4rem;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      transition: transform .5s ease, opacity .5s ease;
    }
    .mode-toggle .moon {
      transform: scale(1) rotate(0deg);
      opacity: 1;
      color: #f1c40f;
    }
    .mode-toggle .sun {
      transform: scale(0) rotate(90deg);
      opacity: 0;
      color: #f39c12;
    }
    :root.dark-mode .mode-toggle .moon {
      transform: scale(0) rotate(-90deg);
      opacity: 0;
    }
    :root.dark-mode .mode-toggle .sun {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
    .container {
      width: 98%;
      background: var(--container-bg);
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      margin: 1rem;
    }
    .content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #log, #detail {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    #log::-webkit-scrollbar, #detail::-webkit-scrollbar { display: none; }
    #log:hover, #detail:hover { scrollbar-width: thin; -ms-overflow-style: auto; }
    #log:hover::-webkit-scrollbar, #detail:hover::-webkit-scrollbar {
      display: block; width:8px;
    }
    #log:hover::-webkit-scrollbar-track, #detail:hover::-webkit-scrollbar-track {
      background: var(--border-color);
    }
    #log:hover::-webkit-scrollbar-thumb, #detail:hover::-webkit-scrollbar-thumb {
      background: var(--header-bg); border-radius:4px;
    }
    #log { overflow-x: hidden; }
    #detail { border-left:1px solid var(--border-color); background:var(--detail-bg); }
    .entry {
      margin-bottom: .5rem;
      font-family: monospace;
      line-height: 1.4;
      display:flex; align-items:flex-start; width:100%;
    }
    .entry .ts {
      color: var(--timestamp-color);
      font-size: .85em;
      width:150px; flex-shrink:0; white-space:nowrap;
    }
    .entry .msg {
      flex:1; overflow-wrap:break-word; max-width:calc(100% - 150px);
    }
    .entry.status {
      font-style:italic; color:var(--status-color);
    }
    .subheader {
      font-weight:bold; margin:1rem 0 .5rem; font-size:1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .filter {
      margin-bottom:.5rem;
    }
    .filter label {
      margin-right:1rem; font-size:1rem;
    }
    .filter select {
      padding:.4rem; border-radius:4px; border:1px solid var(--border-color);
      background:var(--container-bg); color:var(--text-color); font-size:.9rem;
    }
    table {
      width:100%; border-collapse:collapse; margin:.5rem 0;
      font-family:monospace; font-size:.9rem;
    }
    th, td {
      padding:.5rem; border:1px solid var(--border-color);
      text-align:left; word-break:break-all;
    }
    th { background:var(--table-header-bg); }
    #call-table td:first-child, #result-table td:first-child,
    #call-desc td:first-child, #result-desc td:first-child {
      white-space:nowrap;
    }
    .table-footer {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: .5rem;
      width: 100%;
    }
    .table-footer.response-footer {
      justify-content: flex-end;
    }
    .button-group {
      display: flex;
      gap: .5rem;
    }
    .toggle-btn, #getBtn {
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: .4rem .8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    #getConverterBtn, #setConverterBtn, #setRelayBtn, 
    #setHMIBtn, #getRelayBtn, #getMeterBtn, #getTemperatureBtn,
    #getConnectorStatusBtn, #getEVInfoBtn {
      background: var(--table-header-bg);
      color: #000;
      border: 1px solid var(--border-color);
      padding: .4rem .8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    :root.dark-mode #getConverterBtn,
    :root.dark-mode #getRelayBtn,
    :root.dark-mode #getMeterBtn,
    :root.dark-mode #getTemperatureBtn,
    :root.dark-mode #setConverterBtn,
    :root.dark-mode #setRelayBtn,
    :root.dark-mode #setHMIBtn,
    :root.dark-mode #getConnectorStatusBtn,
    :root.dark-mode #getEVInfoBtn {
      color: #fff;
    }
    .emergency-btn {
      background: var(--emergency-btn-bg);
      color: var(--button-text);
      border: none;
      padding: .4rem .8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .toggle-btn:hover, #getBtn:hover, .suffix-btn:hover {
      background: #3ca3f7;
    }
    #getConverterBtn:hover, #setConverterBtn:hover, #setRelayBtn:hover, 
    #setHMIBtn:hover, #getRelayBtn:hover, #getMeterBtn:hover, #getTemperatureBtn:hover,
    #setRelayBtn:hover, #getConnectorStatusBtn:hover,
    #getEVInfoBtn:hover {
      background: var(--command-btn-hover);
    }
    .emergency-btn:hover {
      background: var(--emergency-btn-hover);
    }
    .suffix-btn.active:hover {
      background: #0056b3;
    }
    .toggle-btn {
      margin-left: auto;
    }
    #toggleButtons {
      display: flex;
      justify-content: flex-end;
      flex-grow: 1;
    }
    .emergency-buttons {
      display: flex;
      gap: .5rem;
    }
    .hidden {
      display: none;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--modal-bg);
      border: 1px solid var(--modal-border);
      border-radius: 8px;
      padding: 1.5rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .modal-header {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    .modal-body {
      margin-bottom: 1rem;
    }
    .modal-body label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    .modal-body input, .modal-body select {
      width: 100%;
      padding: 0.4rem;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .modal-btn {
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .modal-btn.cancel {
      background: #6c757d;
    }
    .modal-btn:hover {
      background: #3ca3f7;
    }
    .modal-btn.cancel:hover {
      background: #5a6268;
    }
    .switch-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--switch-bg-off);
      transition: 0.3s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background: var(--switch-handle);
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 1px 3px var(--switch-shadow);
    }
    input:checked + .slider {
      background: var(--switch-bg-on);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    @media(max-width:700px){
      .content { flex-direction:column; }
      #detail { border-left:none; border-top:1px solid var(--border-color); }
      .entry .ts { width:120px; }
      .entry .msg { max-width:calc(100% - 120px); }
      .modal-content { width: 95%; }
      .subheader { flex-direction: column; align-items: flex-start; }
      .emergency-buttons { margin-top: .5rem; width: 100%; justify-content: flex-end; }
    }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 2000;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px);
    }
    :root.dark-mode .toast {
      background: #555;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-title">
      OCPP WSS Center –> <span id="currentCP"></span>
    </div>
    <div class="navbar-buttons">
      <button class="suffix-btn" id="cp01Btn" onclick="switchCP('CP_01')">CP_01</button>
      <button class="suffix-btn" id="cp02Btn" onclick="switchCP('CP_02')">CP_02</button>
      <button class="suffix-btn" id="cp03Btn" onclick="switchCP('CP_03')">CP_03</button>
      <button class="mode-toggle" id="modeToggleBtn" title="Switch to Dark Mode">
        <svg class="icon moon" viewBox="0 0 24 24">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
        </svg>
        <svg class="icon sun" viewBox="0 0 24 24">
          <path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.36 6.36l-1.42-1.42M6.34 6.34L4.93 4.93m12.02 0l-1.42 1.42M6.34 17.66l-1.42 1.42M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="container">
    <div class="content">
      <div id="log">
        <div class="entry status"><span class="ts">--:--:--</span><span class="msg">Please select CP in nav</span></div>
      </div>
      <div id="detail">
        <div class="subheader">
          Request
          <div class="emergency-buttons">
            <button id="emergencyBtnCP_01" class="emergency-btn" data-cp="CP_01">Emergency Stop</button>
            <button id="emergencyBtnCP_02" class="emergency-btn hidden" data-cp="CP_02">Emergency Stop</button>
            <button id="emergencyBtnCP_03" class="emergency-btn hidden" data-cp="CP_03">Emergency Stop</button>
          </div>
        </div>
        <div class="filter">
          <label for="callFilter">Filter Requests:</label>
          <select id="callFilter"><option value="all">All</option></select>
        </div>
        <table id="call-table">
          <tbody></tbody>
        </table>
        <table id="call-desc">
          <thead><tr><th>Name</th><th>Value</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="table-footer">
          <div class="button-group">
            <button id="setConverterBtn">SetConverter</button>
            <button id="setRelayBtn">SetRelay</button>
            <button id="setHMIBtn">SetHMI</button>
          </div>
          <div id="toggleButtons">
            <button id="toggleBtnCP_01" class="toggle-btn" data-cp="CP_01">Start</button>
            <button id="toggleBtnCP_02" class="toggle-btn hidden" data-cp="CP_02">Start</button>
            <button id="toggleBtnCP_03" class="toggle-btn hidden" data-cp="CP_03">Start</button>
          </div>
        </div>
        <div class="subheader">Response</div>
        <div class="filter">
          <label for="resultFilter">Filter Responses:</label>
          <select id="resultFilter"><option value="all">All</option></select>
        </div>
        <table id="result-table">
          <tbody></tbody>
        </table>
        <table id="result-desc">
          <thead><tr><th>Name</th><th>Value</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="table-footer">
          <div class="button-group">
            <button id="getConverterBtn">GetConverter</button>
            <button id="getRelayBtn">GetRelay</button>
            <button id="getConnectorStatusBtn">GetConnectorStatus</button>
            <button id="getEVInfoBtn">GetEVInfo</button>
            <button id="getMeterBtn">GetMeter</button>
            <button id="getTemperatureBtn">GetTemperature</button>
          </div>
          <div class="table-footer response-footer">
            <button id="getBtn">Get</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="commandModal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle"></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button class="modal-btn cancel" id="modalCancel">Cancel</button>
        <button class="modal-btn" id="modalSubmit">Submit</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const host = location.hostname || "localhost", port = 2409;
  let currentCP = '';
  let chargerStatus = { 'CP_01': '', 'CP_02': '', 'CP_03': '' };
  let toggleStates = { 'CP_01': 'Start', 'CP_02': 'Start', 'CP_03': 'Start' };
  let lastMessageTime = { 'CP_01': null, 'CP_02': null, 'CP_03': null };
  let noResponseTimeout = { 'CP_01': null, 'CP_02': null, 'CP_03': null };
  const wsConnections = {
    'CP_01': null,
    'CP_02': null,
    'CP_03': null
  };
  // Store last settings for each command and CP
  const lastSettings = {
    'CP_01': { setConverter: null, setRelay: null, setHMI: null },
    'CP_02': { setConverter: null, setRelay: null, setHMI: null },
    'CP_03': { setConverter: null, setRelay: null, setHMI: null }
  };
  const log           = document.getElementById('log'),
        tblCall       = document.querySelector('#call-table tbody'),
        descCall      = document.querySelector('#call-desc tbody'),
        tblResult     = document.querySelector('#result-table tbody'),
        descResult    = document.querySelector('#result-desc tbody'),
        getBtn        = document.getElementById('getBtn'),
        setConverterBtn       = document.getElementById('setConverterBtn'),
        setRelayBtn           = document.getElementById('setRelayBtn'),
        setHMIBtn             = document.getElementById('setHMIBtn'),
        getConverterBtn       = document.getElementById('getConverterBtn'),
        getConnectorStatusBtn = document.getElementById('getConnectorStatusBtn'),
        getEVInfoBtn          = document.getElementById('getEVInfoBtn'),
        getRelayBtn           = document.getElementById('getRelayBtn'),
        getMeterBtn           = document.getElementById('getMeterBtn'),
        getTemperatureBtn     = document.getElementById('getTemperatureBtn'),
        modeToggleBtn = document.getElementById('modeToggleBtn'),
        callFilter    = document.getElementById('callFilter'),
        resultFilter  = document.getElementById('resultFilter'),
        detail        = document.getElementById('detail'),
        cp01Btn       = document.getElementById('cp01Btn'),
        cp02Btn       = document.getElementById('cp02Btn'),
        cp03Btn       = document.getElementById('cp03Btn'),
        currentCPSpan = document.getElementById('currentCP'),
        modal         = document.getElementById('commandModal'),
        modalTitle    = document.getElementById('modalTitle'),
        modalBody     = document.getElementById('modalBody'),
        modalCancel   = document.getElementById('modalCancel'),
        modalSubmit   = document.getElementById('modalSubmit'),
        toggleBtnCP_01 = document.getElementById('toggleBtnCP_01'),
        toggleBtnCP_02 = document.getElementById('toggleBtnCP_02'),
        toggleBtnCP_03 = document.getElementById('toggleBtnCP_03'),
        emergencyBtnCP_01 = document.getElementById('emergencyBtnCP_01'),
        emergencyBtnCP_02 = document.getElementById('emergencyBtnCP_02'),
        emergencyBtnCP_03 = document.getElementById('emergencyBtnCP_03');

  let requestCommands  = new Set(['all']),
      responseCommands = new Set(['all']),
      messagesByCP = {
        'CP_01': { call: [], result: [] },
        'CP_02': { call: [], result: [] },
        'CP_03': { call: [], result: [] }
      };

  function showToast(message) {
    let toast = document.querySelector('.toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.className = 'toast';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function updateActiveButton(){
    cp01Btn.classList.toggle('active', currentCP === 'CP_01');
    cp02Btn.classList.toggle('active', currentCP === 'CP_02');
    cp03Btn.classList.toggle('active', currentCP === 'CP_03');
  }

  function updateTitle(){
    currentCPSpan.textContent = currentCP || '';
  }

  function updateToggleButtons(){
    toggleBtnCP_01.classList.toggle('hidden', currentCP && currentCP !== 'CP_01');
    toggleBtnCP_02.classList.toggle('hidden', currentCP !== 'CP_02');
    toggleBtnCP_03.classList.toggle('hidden', currentCP !== 'CP_03');
    emergencyBtnCP_01.classList.toggle('hidden', currentCP && currentCP !== 'CP_01');
    emergencyBtnCP_02.classList.toggle('hidden', currentCP !== 'CP_02');
    emergencyBtnCP_03.classList.toggle('hidden', currentCP !== 'CP_03');
  }

  function getWebSocketUrl(cp){
    return `ws://${host}:${port}/${cp}`;
  }

  function startNoResponseTimeout(cp) {
    if (noResponseTimeout[cp]) {
      clearTimeout(noResponseTimeout[cp]);
    }
    noResponseTimeout[cp] = setTimeout(() => {
      if (wsConnections[cp]?.readyState === WebSocket.OPEN) {
        const now = Date.now();
        if (!lastMessageTime[cp] || (now - lastMessageTime[cp] >= 15000)) {
          if (!currentCP || cp === currentCP) {
            appendLog(`Charge for ${cp} no response`, 'status');
          }
        }
        startNoResponseTimeout(cp);
      }
    }, 15000);
  }

  window.switchCP = function(cp){
    if (cp === currentCP) {
      currentCP = '';
    } else {
      currentCP = cp;
    }

    const otherCPs = ['CP_01', 'CP_02', 'CP_03'].filter(otherCP => otherCP !== currentCP);
    otherCPs.forEach(otherCP => {
      if (wsConnections[otherCP] && wsConnections[otherCP].readyState === WebSocket.OPEN) {
        wsConnections[otherCP].close();
        wsConnections[otherCP] = null;
      }
      if (noResponseTimeout[otherCP]) {
        clearTimeout(noResponseTimeout[otherCP]);
        noResponseTimeout[otherCP] = null;
      }
    });

    updateActiveButton();
    updateTitle();
    updateToggleButtons();
    
    if (currentCP) {
      log.innerHTML = `<div class="entry status"><span class="ts">--:--:--</span><span class="msg">Connecting to ${currentCP}…</span></div>`;
      connect(currentCP);
    } else {
      log.innerHTML = `<div class="entry status"><span class="ts">--:--:--</span><span class="msg">No CP selected</span></div>`;
      ['CP_01', 'CP_02', 'CP_03'].forEach(cp => connect(cp));
    }

    requestCommands = new Set(['all']);
    responseCommands = new Set(['all']);
    ['CP_01', 'CP_02', 'CP_03'].forEach(cp => {
      messagesByCP[cp].call.forEach(msg => requestCommands.add(msg.command));
      messagesByCP[cp].result.forEach(msg => responseCommands.add(msg.command));
    });
    updateDropdown(callFilter, requestCommands);
    updateDropdown(resultFilter, responseCommands);
    updateTable('call');
    updateTable('result');
  };

  modeToggleBtn.addEventListener('click', ()=>{
    const isDark = document.documentElement.classList.toggle('dark-mode');
    modeToggleBtn.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  });

  [toggleBtnCP_01, toggleBtnCP_02, toggleBtnCP_03].forEach(btn => {
    btn.addEventListener('click', () => {
      const cp = btn.dataset.cp;
      if (!currentCP) {
        showToast('Please select CP in nav');
        return;
      }
      if (!wsConnections[cp] || wsConnections[cp].readyState !== WebSocket.OPEN) {
        showToast('No connection');
        return;
      }
      const action = toggleStates[cp] === 'Start' ? 'start' : 'stop';
      if (action === 'start' && chargerStatus[cp] !== 'Preparing') {
        showToast('Charger not ready');
        return;
      }
      toggleStates[cp] = action === 'start' ? 'Stop' : 'Start';
      btn.textContent = toggleStates[cp];
      wsConnections[cp].send(action);
      detail.scrollTop = detail.scrollHeight;
    });
  });

  [emergencyBtnCP_01, emergencyBtnCP_02, emergencyBtnCP_03].forEach(btn => {
    btn.addEventListener('click', () => {
      const cp = btn.dataset.cp;
      if (!currentCP) {
        showToast('Please select CP in nav');
        return;
      }
      if (!wsConnections[cp] || wsConnections[cp].readyState !== WebSocket.OPEN) {
        showToast('No connection');
        return;
      }
      toggleStates[cp] = 'Start';
      document.getElementById(`toggleBtn${cp}`).textContent = 'Start';
      wsConnections[cp].send('stop');
      showToast(`Emergency Stop for ${cp}`);
      detail.scrollTop = detail.scrollHeight;
    });
  });

  getBtn.addEventListener('click', ()=>{
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    wsConnections[currentCP].send('get');
    detail.scrollTop = detail.scrollHeight;
  });

  getConverterBtn.addEventListener('click',()=>{
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    wsConnections[currentCP].send('getConverter');
    detail.scrollTop = detail.scrollHeight;
  });

  getConnectorStatusBtn.addEventListener('click',()=>{
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    wsConnections[currentCP].send('getConnectorStatus');
    detail.scrollTop = detail.scrollHeight;
  });

  getEVInfoBtn.addEventListener('click',()=>{
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    wsConnections[currentCP].send('getEVInfo');
    detail.scrollTop = detail.scrollHeight;
  });

  getRelayBtn.addEventListener('click',()=>{
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    wsConnections[currentCP].send('getRelay');
    detail.scrollTop = detail.scrollHeight;
  });

  getMeterBtn.addEventListener('click',()=>{
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    wsConnections[currentCP].send('getMeter');
    detail.scrollTop = detail.scrollHeight;
  });

  getTemperatureBtn.addEventListener('click',()=>{
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    wsConnections[currentCP].send('getTemperature');
    detail.scrollTop = detail.scrollHeight;
  });

  setConverterBtn.addEventListener('click', () => {
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    showModal('setConverter');
  });

  setRelayBtn.addEventListener('click', () => {
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    showModal('setRelay');
  });

  setHMIBtn.addEventListener('click', () => {
    if (!currentCP) {
      showToast('Please select CP in nav');
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      return;
    }
    showModal('setHMI');
  });

  modalSubmit.addEventListener('click', () => {
    if (!currentCP) {
      showToast('Please select CP in nav');
      modal.style.display = 'none';
      return;
    }
    if (!wsConnections[currentCP] || wsConnections[currentCP].readyState !== WebSocket.OPEN) {
      showToast('No connection');
      modal.style.display = 'none';
      return;
    }
    let command = modalTitle.textContent === 'Set Converter' ? 'setConverter' : 
                  modalTitle.textContent === 'Set Relay' ? 'setRelay' : 
                  'setHMI';
    let payload = { ChargerID: currentCP };
    if (command === 'setConverter') {
      const converterStatus = document.getElementById('converterStatus');
      const voltage = document.getElementById('voltage');
      const current = document.getElementById('current');
      if (!converterStatus || !voltage || !current) {
        showToast('Some fields are missing');
        modal.style.display = 'none';
        return;
      }
      payload.Status = converterStatus.checked ? 'On' : 'Off';
      payload.Voltage = parseInt(voltage.value);
      payload.Current = parseInt(current.value);
      // Save settings
      lastSettings[currentCP].setConverter = {
        Status: payload.Status,
        Voltage: payload.Voltage,
        Current: payload.Current
      };
    } else if (command === 'setRelay') {
      const relayStatus = document.getElementById('relayStatus');
      if (!relayStatus) {
        showToast('Some fields are missing');
        modal.style.display = 'none';
        return;
      }
      payload.Status = relayStatus.checked ? 'On' : 'Off';
      // Save settings
      lastSettings[currentCP].setRelay = {
        Status: payload.Status
      };
    } else if (command === 'setHMI') {
      const HMIStatus = document.getElementById('HMIStatus');
      if (!HMIStatus || HMIStatus.value === '') {
        showToast('Please select one status');
        modal.style.display = 'none';
        return;
      }
      payload.Status = HMIStatus.value;
      // Save settings
      lastSettings[currentCP].setHMI = {
        Status: payload.Status
      };
    }
    const uniqueId = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>
      (c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)
    );
    const message = [
      2,
      uniqueId,
      "DataTransfer",
      {
        "vendorId": "Totex",
        "messageId": 1,
        "data": {
          command: command === 'setConverter' ? 'SetConverter' : 
                   command === 'setRelay' ? 'SetRelay' : 
                   'SetHMI',
          payload: payload
        }
      }
    ];
    wsConnections[currentCP].send(JSON.stringify(message));
    detail.scrollTop = detail.scrollHeight;
    modal.style.display = 'none';
  });

  modalCancel.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  function showModal(command) {
    modalTitle.textContent = command === 'setConverter' ? 'Set Converter' : 
                            command === 'setRelay' ? 'Set Relay' : 
                            'Set HMI';
    modalBody.innerHTML = '';
    const settings = lastSettings[currentCP][command];
    if (command === 'setConverter') {
      const status = settings?.Status === 'On' ? 'checked' : '';
      const voltage = settings?.Voltage ?? 423;
      const current = settings?.Current ?? 10;
      modalBody.innerHTML = `
        <div class="switch-container">
          <label for="converterStatus">Status:</label>
          <label class="switch">
            <input type="checkbox" id="converterStatus" ${status}>
            <span class="slider"></span>
          </label>
          <span>${status ? 'On' : 'Off'}</span>
        </div>
        <label for="voltage">Voltage (V):</label>
        <input type="number" id="voltage" value="${voltage}" min="0" step="1">
        <label for="current">Current (A):</label>
        <input type="number" id="current" value="${current}" min="0" step="1">
      `;
    } else if (command === 'setRelay') {
      const status = settings?.Status === 'On' ? 'checked' : '';
      modalBody.innerHTML = `
        <div class="switch-container">
          <label for="relayStatus">Status:</label>
          <label class="switch">
            <input type="checkbox" id="relayStatus" ${status}>
            <span class="slider"></span>
          </label>
          <span>${status ? 'On' : 'Off'}</span>
        </div>
      `;
    } else if (command === 'setHMI') {
      const status = settings?.Status ?? '';
      modalBody.innerHTML = `
        <label for="HMIStatus">Status:</label>
        <select id="HMIStatus">
          <option value="" ${!status ? 'selected' : ''}>Select Status</option>
          <option value="Rapid" ${status === 'Rapid' ? 'selected' : ''}>Rapid</option>
          <option value="Fast" ${status === 'Fast' ? 'selected' : ''}>Fast</option>
          <option value="Available" ${status === 'Available' ? 'selected' : ''}>Available</option>
          <option value="Engage" ${status === 'Engage' ? 'selected' : ''}>Engage</option>
          <option value="Off" ${status === 'Off' ? 'selected' : ''}>Off</option>
        </select>
      `;
    }
    const statusSwitch = modalBody.querySelector('#converterStatus, #relayStatus');
    if (statusSwitch) {
      statusSwitch.addEventListener('change', () => {
        const label = statusSwitch.parentElement.nextElementSibling;
        label.textContent = statusSwitch.checked ? 'On' : 'Off';
      });
    }
    modal.style.display = 'flex';
  }

  function nowTs(){
    const d=new Date(), z=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
  }

  function appendLog(msg,cls=''){
    const e=document.createElement('div'),
          ts=document.createElement('span'),
          ms=document.createElement('span');
    e.className='entry'+(cls?' '+cls:'');
    ts.className='ts'; ts.textContent=nowTs();
    ms.className='msg'; ms.textContent=msg;
    e.append(ts,ms);
    log.appendChild(e);
    log.scrollTop=log.scrollHeight;
  }

  function updateDropdown(dropdown,cmds){
    const sel=dropdown.value;
    dropdown.innerHTML='';
    cmds.forEach(c=>{
      const o=document.createElement('option');
      o.value=c; o.textContent=c;
      dropdown.appendChild(o);
    });
    dropdown.value = cmds.has(sel)?sel:'all';
  }

  function flattenObject(obj, parent = '', res = {}) {
    for (let key in obj) {
      if (obj.hasOwnProperty(key)) {
        if (key === 'ChargerID') continue;
        const propName = parent ? `${parent}.${key}` : key;
        if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
          flattenObject(obj[key], propName, res);
        } else {
          res[propName] = obj[key];
        }
      }
    }
    return res;
  }

  function setLatest(tbl,desc,raw,cp,type,currentCP){
    const atBottom = detail.scrollHeight-detail.clientHeight<=detail.scrollTop+1;
    const filter = type==='call'?callFilter.value:resultFilter.value;
    if(filter==='all' || messagesByCP[cp][type].slice(-1)[0].command===filter){
      tbl.innerHTML=''; desc.innerHTML='';
      const row1 = document.createElement('tr'),
            td1_label = document.createElement('td'),
            td1_value = document.createElement('td');
      td1_label.textContent = 'Timestamp';
      td1_value.innerHTML = `<span class="ts">${nowTs()}</span>`;
      row1.append(td1_label, td1_value);
      
      let rowCount = 2;
      if (!currentCP) {
        rowCount = 3;
        const row2 = document.createElement('tr'),
              td2_label = document.createElement('td'),
              td2_value = document.createElement('td');
        td2_label.textContent = 'Source';
        td2_value.textContent = cp;
        row2.append(td2_label, td2_value);
        tbl.append(row1, row2);
      } else {
        tbl.append(row1);
      }
      
      const rowJson = document.createElement('tr'),
            tdJson_label = document.createElement('td'),
            tdJson_value = document.createElement('td');
      tdJson_label.textContent = 'Raw JSON';
      tdJson_value.textContent = raw;
      rowJson.append(tdJson_label, tdJson_value);
      
      tbl.append(rowJson);
      
      let o;
      try{ o=JSON.parse(raw); }
      catch{
        const r=document.createElement('tr'),
              n=document.createElement('td'),
              v=document.createElement('td');
        n.textContent='raw'; v.textContent=raw;
        r.append(n,v); desc.appendChild(r);
        if(atBottom) detail.scrollTop=detail.scrollHeight;
        return;
      }
      if(Array.isArray(o)){
        if (o[0] === 2 || o[0] === 3) {
          if (type === 'call' && o[3] && typeof o[3] === 'object' && o[3].data && o[3].data.payload) {
            const flattenedPayload = flattenObject(o[3].data.payload);
            Object.entries(flattenedPayload).forEach(([k, v]) => {
              const r = document.createElement('tr'),
                    n = document.createElement('td'),
                    v2 = document.createElement('td');
              n.textContent = k;
              v2.textContent = typeof v === 'object' ? JSON.stringify(v) : String(v);
              r.append(n, v2);
              desc.appendChild(r);
            });
          } else if (type === 'result' && o[2] && typeof o[2] === 'object' && o[2].data && o[2].data.payload) {
            const flattenedPayload = flattenObject(o[2].data.payload);
            Object.entries(flattenedPayload).forEach(([k, v]) => {
              const r = document.createElement('tr'),
                    n = document.createElement('td'),
                    v2 = document.createElement('td');
              n.textContent = k;
              v2.textContent = typeof v === 'object' ? JSON.stringify(v) : String(v);
              r.append(n, v2);
              desc.appendChild(r);
            });
          }
        }
      } else if(o&&typeof o==='object'){
        const flattenedObj = flattenObject(o);
        Object.entries(flattenedObj).forEach(([k,v])=>{
          const r=document.createElement('tr'),
                n=document.createElement('td'),
                v2=document.createElement('td');
          n.textContent=k;
          v2.textContent=typeof v==='object'?JSON.stringify(v):String(v);
          r.append(n,v2); desc.appendChild(r);
        });
      } else {
        const r=document.createElement('tr'),
              n=document.createElement('td'),
              v2=document.createElement('td');
        n.textContent='value'; v2.textContent=String(o);
        r.append(n,v2); desc.appendChild(r);
      }
      if(atBottom) detail.scrollTop=detail.scrollHeight;
    }
  }

function categorize(raw, cp){
    let o;
    try{ o=JSON.parse(raw); }catch{return;}
    if(!Array.isArray(o)) return;
    const t0=o[0], ts=nowTs();
    if((t0===2 || t0===3)){
      lastMessageTime[cp] = Date.now();
      startNoResponseTimeout(cp);
    }
    if(t0===2){
      const action=o[2];
      let cmd = action;
      if (o[3] && typeof o[3] === 'object' && o[3].data && o[3].data.command) {
        cmd = o[3].data.command;
      }
      if(cmd==='Heartbeat') return;
      if(cmd === 'StatusNotification' && o[3] && o[3].status) {
        chargerStatus[cp] = o[3].status;
      }
      if (cmd && typeof cmd === 'string' && cmd.trim() !== '') {
        requestCommands.add(cmd);
        messagesByCP[cp].call = [{command:cmd,raw,ts}];
        updateDropdown(callFilter,requestCommands);
        setLatest(tblCall,descCall,raw,cp,'call',currentCP);
      }
    } else if(t0===3){
      const p=o[2];
      let cmd = null;
      if(p && typeof p === 'object' && p.command) {
        cmd = p.command;
      } else if (p && typeof p === 'object' && p.data && p.data.command) {
        cmd = p.data.command;
      }
      if (!cmd && o[2] && typeof o[2] === 'string') {
        cmd = o[2];
      }
      if (cmd && typeof cmd === 'string' && cmd.trim() !== '') {
        responseCommands.add(cmd);
        messagesByCP[cp].result = [{command:cmd,raw,ts}];
        updateDropdown(resultFilter,responseCommands);
        setLatest(tblResult,descResult,raw,cp,'result',currentCP);
      } else {
        messagesByCP[cp].result = [{command:null,raw,ts}];
        setLatest(tblResult,descResult,raw,cp,'result',currentCP);
      }
    }
  }

  function updateTable(type){
    const tbl  = type==='call'?tblCall:tblResult,
          desc = type==='call'?descCall:descResult,
          filter = type==='call'?callFilter.value:resultFilter.value;
    tbl.innerHTML=''; desc.innerHTML='';
    let latestMessages = [];
    if (currentCP) {
      const arr = messagesByCP[currentCP][type];
      if (arr.length && (filter==='all' || arr[0].command===filter)) {
        latestMessages.push({cp: currentCP, ...arr[0]});
      }
    } else {
      ['CP_01', 'CP_02', 'CP_03'].forEach(cp => {
        const arr = messagesByCP[cp][type];
        if (arr.length && (filter==='all' || arr[0].command===filter)) {
          latestMessages.push({cp, ...arr[0]});
        }
      });
      latestMessages.sort((a,b) => new Date(b.ts) - new Date(a.ts));
    }
    if(latestMessages.length) {
      const latest = latestMessages[0];
      setLatest(tbl,desc,latest.raw,latest.cp,type,currentCP);
    }
  }

  callFilter.addEventListener('change',()=>{
    updateTable('call');
  });

  resultFilter.addEventListener('change',()=>{
    updateTable('result');
  });

  function connect(cp){
    if (wsConnections[cp] && wsConnections[cp].readyState === WebSocket.OPEN) {
      return;
    }
    wsConnections[cp] = new WebSocket(getWebSocketUrl(cp));
    wsConnections[cp].onopen = () => {
      lastMessageTime[cp] = Date.now();
      startNoResponseTimeout(cp);
    };
    wsConnections[cp].onmessage = (ev) => {
      if (!currentCP || cp === currentCP) {
        appendLog(ev.data);
      }
      categorize(ev.data, cp);
    };
    wsConnections[cp].onclose = () => {
      wsConnections[cp] = null;
      if (noResponseTimeout[cp]) {
        clearTimeout(noResponseTimeout[cp]);
        noResponseTimeout[cp] = null;
      }
      setTimeout(() => connect(cp), 3000);
    };
    wsConnections[cp].onerror = (err) => {
      console.error(`WebSocket error for ${cp}:`, err);
      if (!currentCP || cp === currentCP) {
        appendLog(`WebSocket error for ${cp}`, 'status');
      }
    };
  }

  ['CP_01', 'CP_02', 'CP_03'].forEach(cp => connect(cp));
  updateActiveButton();
  updateTitle();
  updateToggleButtons();
  updateDropdown(callFilter, requestCommands);
  updateDropdown(resultFilter, responseCommands);
})();
</script>
</body>
</html>
